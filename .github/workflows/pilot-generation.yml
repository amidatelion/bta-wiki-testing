name: Pilot Automation
run-name: Pushing Pilot Updates to BTA Wiki
on:
    push:
      branches:
        - wiki
jobs:
    post-to-wiki:
        name: Post Updates to Wiki
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4
              with:
                repository: ${{ github.repository }}
                path: bta
            - name: Check out automation code
              uses: actions/checkout@v4
              with:
                repository: 'amidatelion/bta-wiki-automation'
                path: wiki-gen
            - name: Check state of API
              run: |
                  echo "curling bta API"
                  curl https://www.bta3062.com/api.php
            - name: Enable Cloudflare API workaround
              env:
                CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
              run: |
                python3 /home/runner/work/bta-wiki-testing/bta-wiki-testing/wiki-gen/src/toggleCloudflareApi.py enable
            - name: Re-check state of API post toggle
              run: |
                  echo "curling bta API"
                  curl https://www.bta3062.com/api.php
            - name: Run Pilot automation
              env:
                WIKI_PASS: ${{ secrets.WIKI_PASS }}
                WIKI_USER: ${{ secrets.WIKI_USER}}
              run: |
                python3 /home/runner/work/bta-wiki-testing/bta-wiki-testing/wiki-gen/src/pilotRenderer.py
            - name: Disable Cloudflare API workaround
              env:
                CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
              run: |
                python3 /home/runner/work/bta-wiki-testing/bta-wiki-testing/wiki-gen/src/toggleCloudflareApi.py disable